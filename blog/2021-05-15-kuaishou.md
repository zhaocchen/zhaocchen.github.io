---
slug: kuaishou
title: 快手技术嘉年华笔记
sub_title: hehhe
author: Zhao chen
author_url: https://github.com/zhaocchen
tags: []
draft: true
description:  快手技术嘉年华 揭秘快手春节战役背后的技术
---

<!--truncate-->

副标题：揭秘快手春节战役背后的技术

前端分论坛

[TOC]



## 配置化大屏系统的挑战与实现

分享人： 李京

产品名称：kscreen, 通过拖拽， 配置组件提升大屏开发效率。

### 背景

1. 研发流程长、协作成本高
2. 需求增多但资源沉淀少、方案复用度低

#### 建议抽象复用

尝试简单的配置化

展示层： 数据轮询、配置轮询、切换控制。。。

基础： 定制化组件、标准化JSON描述

具体实现：

- 编辑器： 建议JSON编辑器， 简易布局拖拽
- 后台管理：看板、指标管理， 系统管理

### 可视化大屏搭建系统

#### 一个目标：研发提效

1. 灵活编辑
2. 模版复用
3. 组件服用
4. 3d视觉
5. 屏幕适配
6. 数据接入

#### 两个视角：创建者、研发者

##### 大屏(创建者)

目标： 更快、更好、更强

1. 创建：模板创建
2. 编辑：布局拖拽 -> 组件配置 -> 数据接入 -> 事件动画
3. 发布：权限授予

##### 组件(研发者)

1. 创建： 样板代码、开发文档、自有仓库、本地环境
2. 开发：本地预览、逻辑解耦
3. 发布： 一键发布、信息维护
4. 使用：一键安装、一键升级

#### 五个要素：框架到细节

布局结构：组件树、可选组件、画布、配置面板

#### 要素1： 组件

##### 抽象方式：配置面板（Schema）、渲染器（Render）、元信息（Info）、升级函数（Update）



##### 插件化实现：组件和大屏核心逻辑解耦

组件加载器：版本加载 + 依赖分析 + 组件缓存

大屏能力内聚： 组件SDK + 封装 Decorator

#### 要素2：画布

目标：自由拖拽、缩放功能、对齐线、标尺功能、距离计算、设置参考线、方向调整、缩略图、成组组合、靠近吸附

推荐： 绝对布局 + 局部流式布局

| 布局引擎 | 堆叠布局（绝对布局）                                         | 流式布局                             | 网格布局                                           |
| -------- | ------------------------------------------------------------ | ------------------------------------ | -------------------------------------------------- |
| 优势     | 1. 自由拖拽，组件之间相互影响小<br />2. 设计类软件大多类似绝对布局，符合直觉 | 组件按照顺序依次排布                 | 1. 模块间挤压，按照网格排布<br />2. 特定场景下高效 |
| 劣势     | 需要考虑层级，否则会出现遮盖，且层叠组件交互不方便           | 拖拽交互不友好（自动排列在空白位置） | 实现层级之间的交互困难（如：嵌套层级之间拖拽）     |
| 案例     |                                                              |                                      | BI                                                 |



#### 要素3： 联动动画

- 动画 Wrapper
- 事件 Wrapper

#### 要素4： 数据接入​

主要问题：

1. 合并请求：多个请求间仅参数不同
2. 公用数据：多个组件公用同一份数据
3. 渲染优化： 并行请求引起的并行渲染需要打散

数据获取 -> 数据处理 ->  数据映射 ->   最终数据

#### 要素5：全局变量

数据请求、数据过滤、事件执行、组件配置  ---------->>>>>>>     编辑器、渲染器

### 保障方案（主备链路切换）

主、备用数据链路 

↓    无感切换

兜底策略

↓

图表渲染

##### 配置更新能力

1. 配置轮询，实时更新
2. 配置Diff, 增量更新
3. FPS 监控， 渲染打散

### 展望

- 易用性： 可视化逻辑编辑器

- 提效
  - 实时多人协作
  - 组件组合保存成区块
  - 设计稿的导入和快速排版

- 保障： 远程监控和控制

- 突破：3D图形编辑

## 大型活动中复杂动效的取舍与实现

分享人： 申天义

### 背景

1. 体积：5M/25M
2. UI和动效还原度： 100%
3. 稳定性保障： < 1‰

### 实施

#### 体积控制

JS/CSS/HTML
UI素材
游戏引擎
动效素材

预估资源后， 对体积按照公告版、安全版、简单版、完整版进行控制。例如， 业务逻辑0.5M、2D游戏资源+引擎1M、3D游戏资源+引擎12M

> 版本区别

#### 动效方案

| 动效方案 | 优势 | 劣势 |
| --- | --- | --- |
| APNG | 兼容性好、性能较好 | 体积大、设计师只做不便 |
| Lottie |  |  |
| 透明视频 | CPU占用适中、体积较小（序列帧动画） | 兼容性一般 |
| css动画 | 性能好、体积较小（非序列帧）、兼容性好 | 开发复杂 |

25M如何压缩至5M：

1. 3D降2D
2. 降级动效
3. 部分资源不预置，改为按需preload(mp3,mp4)

##### 决策

##### 动画串联

动画常见两大问题：

1. 内容动态替换
2. 多段动画衔接或配合

动画拆解：

1. 序列帧：背景光效+福袋打开
2. 动效内容： 下落的福袋+打开后卡片

##### 降级设计

常规性能降级方案：

- 2套代码逻辑
- 3中记载方案
- 2种呈现方案

异常和边界情况降级

- 系统版本
- 崩溃次数

### 总结

1. 如何更方便的实现预加载
2. 多组动画如何协调
3. 工具链补充

共享png压缩算法
​

### QA

预置包5M更新，jsv
​

动画线上监控？考虑到线上监控消耗性能，没有线上监控，采用开发和测试覆盖综合评估可行性。
​

## 前端度量与实时监控保障

分享人： 高毓谦

### 背景

页面加载的流程：DNS解析 -> 建立网络链接 -> 渲染DOM -> 资源加载

面临挑战：

1. 业务线众多， 各个业务监控能力分散， 性能指标定义混乱
2. 每天数亿级别的用户访问
3. 重大活动搞流量场景下上万级QPS场景

目标， 一套稳定、易用、可靠的前端实时监控的解决方案：

- 统一指标度量
- 实时日志展示
- 整体链路保障

### 定义页面性能

按数据类型划分，一个SDK需要以下几个角度考虑：

- load
  - H5指标
  - 客户端指标
- API
  - Ajax
  - Fetch
- Error
  - window.onerror
  - addEventListener('error')
  - unhandlerejection
- Resource
  - JavaScript
  - CSS
  - Image
- Custom
  - 自定义指标
  - 自定义维度
  - 自定义事件

#### 计算FMP

常规FMP

依据需求重新定义

```
mounted() {
 // 上报
 SDK.plugins.fmp();
}

const perf = performance.timing;
const now = Date.now();
const fmp = now - perf.navigationStart;
```

#### 获取最大内容

```
new PerformanceObserver((entryList) => {
 for (const entry of entryList.getEntries()) {
  console.log('lcp:', entry);
 }
}).observe({
 type: 'larget-contentful-pait'
})
```

- 文本节点和包含文本元素的块级元素
- 图片节点
- 使用url()作为背景的节点
- 使用了预览图属性的xxx

#### 确定元素大小

1. 元素的大小只计算出现在屏幕中的大小。
2. 对于媒体元素来说， 只计算资源原有尺寸和绘制尺寸中较小的数值。
3. 不考虑任何边框和间距。

#### 小结

浏览器

| 第一次像素渲染             | 第一个节点绘制到页面                      | 主要内容出现到页面 | 绘制最大的内容出现在页面 |
| -------------------------- | ----------------------------------------- | ------------------ | ------------------------ |
| 首次出现和白屏不一致的内容 | 首次绘制文本、图像、非空白Canvas、svg节点 | 页面的主要内容     | 绘制面积最大的内容       |
|                            |                                           |                    |                          |
|                            |                                           |                    |                          |

### 保障数据链路的稳定性

#### 链路框架

#### SDK稳定性保障

##### 节流上报

##### 动态采样

##### 上报降级

##### 设备兼容

#### 数据服务稳定性保障

##### 数据拆分

1. 指标和维度区分
2. 不同项目按访问量区分
3. 重点项目高优保障

##### 动态降级

1. 数据量波动实时监控
2. 数据类型区分优先级
3. 针对突发访问量降级处理

##### 容灾互备

1. 多链路互备
2. 多机器部署

#### 展示平台稳定性保障

##### 前端Node端

多实例部署

Node服务监控

实时监控

##### 服务端稳定性保障

数据预热

离线缓存

分段xx

#### 小结

- JS SDK
  - 节流上报
  - 动态采样
  - 上报降级
  - 环境兼容
- 数据处理
  - 数据拆分
  - 容灾互备
  - 优先级保障
  - 动态降级
- 数据后端
  - 离线缓存
  - 数据预热
  - 数据分段
- 平台展示
  - 多实例部署
  - node监控
  - xxx

### 展望

统一的性能监控平台 = 性能检测 + 性能监控

## 并发下的活动预案和稳定性方案设计

分享人： 殷勇

### 背景

问题：

目标：

CDN稳定性

客户端稳定性

<!-- 
cdn 域名打散
publicpath，ewbapck中静态资源路径
也是file-loader中rule
​

离线包拆分（分治） -->
​

### 展望

1. 多级平滑降级模型
2. 设备能力自评估模型

## 如何借助H5容器优化重大活动体验

分享人： 宋云路

### 背景

### 极致的体验优化

#### WebView启动过程优化

Step1：

Step2：

Step3：

Step4：

Step5：

#### 离线优化

##### 更快触达用户

##### 降低CDN依赖

#### 运行时配置优化

### 稳定性保证实践

### 展望

#### 小结

#### 展望

- 平台化
- 性能优化
- 稳定性提升
- 研发提效
